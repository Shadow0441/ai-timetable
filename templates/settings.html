{% extends "layout.html" %}
{% block title %}Settings - TimeWeave AI{% endblock %}

{% block head_styles %}
<style>
    .content-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        padding: 2rem;
        border-radius: 1rem;
        margin-bottom: 2rem;
        height: 100%;
    }
    .card-title {
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    .card-subtitle {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
    }
    .form-label {
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }
    .form-control, .form-select {
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        color: var(--text-primary);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(157,78,221,0.2);
        background-color: var(--background-dark);
        color: var(--text-primary);
    }
    .btn-submit {
      background: linear-gradient(135deg, var(--accent), var(--accent-alt));
      border: none;
      color: #fff;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(157,78,221,0.4);
    }
    .schema-section {
        border-left: 3px solid var(--accent-alt);
        padding-left: 1rem;
        margin-bottom: 1.5rem;
    }
    .table-dark-custom th, .table-dark-custom td {
        white-space: nowrap;
    }
    /* FIX: Ensures cards in the same row have equal height */
    .row.match-height {
        display: flex;
        flex-wrap: wrap;
    }
    .row.match-height > [class*='col-'] {
        display: flex;
        flex-direction: column;
    }
    .row.match-height .content-card {
        flex-grow: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="row match-height">
    <!-- Left Column for General Settings & Student Management -->
    <div class="col-lg-5 mb-4">
        <div class="content-card">
            <h4 class="card-title"><i class="fas fa-sliders-h me-2 text-accent"></i>General Settings</h4>
            <p class="card-subtitle">Configure core timetable parameters.</p>
            <form method="POST" action="{{ url_for('settings') }}">
                <input type="hidden" name="form_type" value="general_settings">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="total_rooms" class="form-label">Total Classrooms</label>
                        <input type="number" class="form-control" id="total_rooms" name="total_rooms" value="{{ institute.settings.total_rooms }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="total_labs" class="form-label">Total Labs</label>
                        <input type="number" class="form-control" id="total_labs" name="total_labs" value="{{ institute.settings.total_labs }}" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="start_time" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="start_time" name="start_time" value="{{ institute.settings.start_time }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="end_time" class="form-label">End Time</label>
                        <input type="time" class="form-control" id="end_time" name="end_time" value="{{ institute.settings.end_time }}" required>
                    </div>
                </div>
                <button type="submit" class="btn-submit w-100 mt-3">
                    <i class="fas fa-save me-2"></i>Save General Settings
                </button>
            </form>
        </div>
    </div>

    <!-- Right Column for DB Schema Mapping -->
    <div class="col-lg-7 mb-4">
        <div class="content-card">
            <h4 class="card-title"><i class="fas fa-database me-2 text-accent"></i>Database Schema Mapping</h4>
            <p class="card-subtitle">
                <i class="fas fa-info-circle me-1"></i>
                Our system will first try to auto-detect a standard schema. Use this form only if that fails.
            </p>

            <form method="POST" action="{{ url_for('settings') }}">
                <input type="hidden" name="form_type" value="schema_settings">

                <div class="schema-section">
                    <h5>Subjects</h5>
                    <div class="row">
                        <div class="col-md-6 mb-2"><input type="text" class="form-control" name="s_table" placeholder="Table Name (e.g., subjects)" value="{{ config.get('subjects', {}).get('table') }}"></div>
                        <div class="col-md-6 mb-2"><input type="text" class="form-control" name="s_name" placeholder="Subject Name Column" value="{{ config.get('subjects', {}).get('name') }}"></div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6 mb-2"><input type="text" class="form-control" name="s_branch_fk" placeholder="Branch Foreign Key" value="{{ config.get('subjects', {}).get('branch_fk') }}"></div>
                        <div class="col-md-6 mb-2"><input type="text" class="form-control" name="s_year" placeholder="Year Column" value="{{ config.get('subjects', {}).get('year') }}"></div>
                    </div>
                </div>

                <div class="schema-section">
                    <h5>Branches & Courses</h5>
                    <div class="row">
                        <div class="col-md-4 mb-2"><input type="text" class="form-control" name="b_table" placeholder="Branches Table" value="{{ config.get('branches', {}).get('table') }}"></div>
                        <div class="col-md-4 mb-2"><input type="text" class="form-control" name="b_name" placeholder="Branch Name Column" value="{{ config.get('branches', {}).get('name') }}"></div>
                        <div class="col-md-4 mb-2"><input type="text" class="form-control" name="b_course_fk" placeholder="Course Foreign Key" value="{{ config.get('branches', {}).get('course_fk') }}"></div>
                    </div>
                     <div class="row mt-2">
                        <div class="col-md-6 mb-2"><input type="text" class="form-control" name="c_table" placeholder="Courses Table" value="{{ config.get('courses', {}).get('table') }}"></div>
                        <div class="col-md-6 mb-2"><input type="text" class="form-control" name="c_name" placeholder="Course Name Column" value="{{ config.get('courses', {}).get('name') }}"></div>
                    </div>
                </div>

                <div class="schema-section">
                     <h5>Faculty, Rooms, & Mapping</h5>
                     <div class="row">
                        <div class="col-md-6 mb-2"><input type="text" class="form-control" name="f_table" placeholder="Faculty Table" value="{{ config.get('faculty', {}).get('table') }}"></div>
                        <div class="col-md-6 mb-2"><input type="text" class="form-control" name="f_name" placeholder="Faculty Name Column" value="{{ config.get('faculty', {}).get('name') }}"></div>
                    </div>
                     <div class="row mt-2">
                        <div class="col-md-6 mb-2"><input type="text" class="form-control" name="r_table" placeholder="Rooms Table" value="{{ config.get('rooms', {}).get('table') }}"></div>
                        <div class="col-md-6 mb-2"><input type="text" class="form-control" name="r_name" placeholder="Room Name Column" value="{{ config.get('rooms', {}).get('name') }}"></div>
                    </div>
                     <div class="row mt-2">
                        <div class="col-md-4 mb-2"><input type="text" class="form-control" name="map_table" placeholder="Faculty-Subject Junction Table" value="{{ config.get('map', {}).get('table') }}"></div>
                        <div class="col-md-4 mb-2"><input type="text" class="form-control" name="map_s_fk" placeholder="Subject Foreign Key" value="{{ config.get('map', {}).get('subject_fk') }}"></div>
                        <div class="col-md-4 mb-2"><input type="text" class="form-control" name="map_f_fk" placeholder="Faculty Foreign Key" value="{{ config.get('map', {}).get('faculty_fk') }}"></div>
                    </div>
                </div>

                <button type="submit" class="btn-submit w-100 mt-3">
                    <i class="fas fa-save me-2"></i>Save Manual Schema
                </button>
            </form>
        </div>
    </div>

    <!-- FIX: Moved student management into a full-width row at the bottom for better layout -->
    <div class="col-12">
        <div class="content-card">
             <div class="row">
                <div class="col-md-6">
                    <h4 class="card-title"><i class="fas fa-user-plus me-2 text-accent"></i>Add New Student</h4>
                    <p class="card-subtitle">Onboard students to the portal.</p>
                    <form method="POST" action="{{ url_for('add_student') }}">
                         <div class="mb-3">
                            <label for="name" class="form-label">Student Name</label>
                            <input type="text" class="form-control" id="name" name="name" placeholder="Full name" required>
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="admission_id" class="form-label">Admission ID</label>
                                <input type="text" class="form-control" id="admission_id" name="admission_id" placeholder="Student's unique ID" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="year" class="form-label">Year</label>
                                <input type="number" class="form-control" id="year" name="year" placeholder="e.g., 1" required min="1" max="5">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" placeholder="Create a temporary password" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="course" class="form-label">Course</label>
                                <input type="text" class="form-control" id="course" name="course" placeholder="e.g., B.Tech" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="branch" class="form-label">Branch</label>
                                <input type="text" class="form-control" id="branch" name="branch" placeholder="e.g., Computer Science" required>
                            </div>
                        </div>
                        <button type="submit" class="btn-submit w-100 mt-2">
                            <i class="fas fa-plus-circle me-2"></i>Add Student
                        </button>
                    </form>
                </div>
                <div class="col-md-6">
                    <h4 class="card-title"><i class="fas fa-users me-2 text-accent"></i>Existing Students</h4>
                    <p class="card-subtitle">A list of all registered students.</p>
                    {% if institute.students %}
                    <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                        <table class="table table-dark-custom">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Admission ID</th>
                                    <th>Branch</th>
                                    <th>Year</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in institute.students %}
                                <tr>
                                    <td>{{ student.name }}</td>
                                    <td>{{ student.admission_id }}</td>
                                    <td>{{ student.branch }}</td>
                                    <td>{{ student.year }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-secondary text-center mt-5">No students have been added yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

